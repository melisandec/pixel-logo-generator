<!DOCTYPE html>
<html>
<head>
    <title>Download Test</title>
</head>
<body>
    <h1>Download Functionality Test</h1>
    <button id="testDownload">Test Download</button>
    <div id="status"></div>
    
    <script>
        // Simulate the download function
        async function testDownload() {
            const status = document.getElementById('status');
            status.textContent = 'Testing...';
            
            // Create a test image data URL
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(0, 0, 100, 100);
            ctx.fillStyle = '#000000';
            ctx.font = '20px Arial';
            ctx.fillText('TEST', 20, 50);
            
            const dataUrl = canvas.toDataURL('image/png');
            const filename = 'test-logo.png';
            const isMobileDevice = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            try {
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                const file = new File([blob], filename, { type: 'image/png' });
                
                if (isMobileDevice) {
                    status.textContent = 'Mobile device detected. Testing Web Share API...';
                    
                    if (navigator.share) {
                        try {
                            let shareSucceeded = false;
                            if (navigator.canShare) {
                                try {
                                    if (navigator.canShare({ files: [file] })) {
                                        await navigator.share({
                                            files: [file],
                                            title: 'Test Logo',
                                            text: 'Save your pixel logo',
                                        });
                                        shareSucceeded = true;
                                        status.textContent = '✅ Web Share API opened successfully!';
                                        return;
                                    }
                                } catch (canShareError) {
                                    console.log('canShare check failed:', canShareError);
                                }
                            }
                            
                            if (!shareSucceeded) {
                                await navigator.share({
                                    title: 'Test Logo',
                                    text: 'Save your pixel logo',
                                    url: dataUrl,
                                });
                                shareSucceeded = true;
                                status.textContent = '✅ Web Share API opened successfully (URL mode)!';
                                return;
                            }
                        } catch (shareError) {
                            if (shareError.name === 'AbortError') {
                                status.textContent = 'ℹ️ User cancelled share dialog';
                                return;
                            }
                            status.textContent = '⚠️ Web Share API failed: ' + shareError.message;
                        }
                    }
                    
                    // Fallback
                    const objectUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = objectUrl;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(objectUrl);
                    }, 1000);
                    status.textContent = '⚠️ Using fallback download method';
                } else {
                    // Desktop
                    status.textContent = 'Desktop detected. Testing download...';
                    const objectUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = objectUrl;
                    link.rel = 'noopener';
                    link.style.cssText = 'position: fixed; top: -9999px; opacity: 0; pointer-events: none;';
                    
                    document.body.appendChild(link);
                    
                    try {
                        link.click();
                        status.textContent = '✅ Download triggered! Check your downloads folder.';
                    } catch (e) {
                        const clickEvent = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window,
                        });
                        link.dispatchEvent(clickEvent);
                        status.textContent = '✅ Download triggered (fallback method)! Check your downloads folder.';
                    }
                    
                    setTimeout(() => {
                        if (document.body.contains(link)) {
                            document.body.removeChild(link);
                        }
                        URL.revokeObjectURL(objectUrl);
                    }, 300);
                }
            } catch (error) {
                status.textContent = '❌ Error: ' + error.message;
                console.error('Download error:', error);
            }
        }
        
        document.getElementById('testDownload').addEventListener('click', testDownload);
    </script>
</body>
</html>
